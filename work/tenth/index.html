<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>jQuery</title>
    <link rel="stylesheet" href="../../common/css/reset.css">
    <link rel="stylesheet" href="../../common/css/base.css">
    <link rel="stylesheet" href="./css/style.css">
  </head>
  <body>
    <div class="wrap">
      <div class="container">
        <div class="header">
          <p class="header__title">Search Books!</p>
        </div>
        <div class="search">
          <div class="search__text">
            <input type="text" id="js-search-word" class="search__text__input" placeholder="検索する">
          </div>
          <button id="js-search-button" class="search__btn">検索する</button>
        </div>
        <ul class="lists"></ul>
      </div>
    </div>
    <script src="../../common/js/jquery.js"></script>
    <script>
      //①最後のページに次へを押したら、リクエストを飛ばさずに「これ以上ありません」【解決！】
        //→jqueryの関数：disa〜がついているときは○○する
      //②検索は成功しているが、0件の場合→レスポンス【解決！】
      //③offlineでエラーメッセージが出て、onlineになったら再度検索できるようになる
      //④もう一回全部試してみること


        // 楽天ブックスの総合検索APIを使って製作してください。
        // answerの挙動を良く見てね！
        //
        // 下記URLにAPIの仕様が載ってるいので、ブラウザで開いて参考にしてください。
        // https://webservice.rakuten.co.jp/api/bookstotalsearch/
        //
        // [使うメソッド]
        // $.each(配列, function functionName() {}) 配列に対しての繰り返し処理
        // $.ajax({}) 外部ファイルやURLに対してデータをリクエストすることができます。
        // 以下は今回使う$.ajaxの基本的な形です。
        //
      $(function() {
        var param = {
          applicationId: '1019399324990976605',
          booksGenreId: '001',
          keyword: '', //空で作成
          hits: 20,
          page: 1,
        };

        var isMax = false; //paramの中には入れない。元々無いのは入れない方がよい。最初は最後のページじゃないから初期値はfalse
        var pager = "<div class='js-pager'>" +
                      "<ul class='btn-wrapper'>" +
                        "<li class='prev btn-item'>" +
                          "<a class='btn-anchor' href='#'>前へ</a>" +
                        "</li>" +
                        "<li class='next btn-item'>" +
                          "<a class='btn-anchor' href='#'>次へ</a>" +
                        "</li>" +
                          // ".append('<li class='next btn-item'><a class='btn-anchor' href=''>次へ</a></li>)"+
                      "</ul>" +
                    "</div>"

        // console.log(pager);

        // こっちの書き方だとイベント登録できる
        $(document).on('click', '.prev', function(e) {
          $('.message').remove();
          console.log(e);
          if(param.page === 1) { //1ページ目であれば
            return false; //ボタンを機能させない
          } else {
            param.page--; //1ずつ減算（デクリメント
            searchBooks(param); //本検索関数実行
            console.log(param);
          }
        });

        $(document).on('click', '.next', function() { //第二引数が対象でdocumentはざっくり言うとhtmlを装飾するためのもの
          $('.message').remove(); //表示されているメッセージ消去
          if(param.isMax === true) { //ページ総数＝いるページ数（最大ページ数）であれば
            if($('.next').hasClass('disabled')) { //もしdisabledクラスがついていたら
              $('.lists').before('<div class="message">これ以上はありません</div>');
              $("html,body").animate({scrollTop:0},"0");
            }
            return false; //ボタン機能しない（これがないとボタンが機能しちゃう
          } else { //
            param.page++; //1ずつ出していく（インクリメント
            searchBooks(param); //本検索関数実行
            console.log(param);
          }
        });

        // 検索クリックした時の処理
        $('#js-search-button').on('click',function() {  //検索ボタンを押したら
          $('.message').remove(); //表示されているメッセージ消去
          $('.lists li').remove(); //検索結果消去
          param.page = 1; //今いるページを1ページ目に設定
          param.keyword = $('#js-search-word').val(); //検索されたキーワードの値（value）を変数にいれる
          searchBooks(param); //本検索関数実行
        });


        // 本を件する関数
        function searchBooks(param) {
          // ajaxの成功時と失敗時の処理
          $.ajax({ //JavaScriptを使って非同期通信をする「Asynchronous JavaScript ＋ XML」の略。JavaScriptさんに新しいページを貰う
            url: 'https://app.rakuten.co.jp/services/api/BooksTotal/Search/20130522', //リクエスト先
            type: 'GET', //サーバーからデータを取得することを目的 どんな方法で？
            datatype: 'json',  //あなたが期待するサーバーから返されるデータの型を指定します。"json"<-JSONとしてレスポンスを評価し、JavaScriptオブジェクトが返されます。サーバーから期待するレスポンスのデータ形式を指定
            data: param,

          }).done(function(data) {
            success(data);
          }).fail(function(error) {
            miss(error);
          });
        }
        //エラー時にテキストを表示する関数
        function errorText(displayWord) {
          $('.lists').before('<div class="message">' + displayWord + '</div>');
          console.log(displayWord);
        }

        // ajax成功時処理
        function success(data) {  //ココに入ってくるのは取得してきた値
          $('.js-pager').remove(); //前へ、次へボタン消去
          $('.lists li').remove(); //検索結果
          var result = ''; //eachの外でも使えるようにeachの外で宣言
          $.each(data.Items,function(index,element) {
            console.log(element);
            result += "<li class='lists__item'>"+  //+=でresultに結果をどんどん足している
                        "<div class='lists__item__inner'>"+
                          "<a href='"+element.Item.itemUrl+"' class='lists__item__link' target='_blank'>"+
                            "<img src='"+element.Item.largeImageUrl+"' class='lists__item__img' alt='"+"ほんの写真"+"'>"+
                            "<p class='lists__item__detail'>作品名："+element.Item.title+"</p>"+
                            "<p class='lists__item__detail'>作者　："+element.Item.author+"</p>"+
                            "<p class='lists__item__detail'>出版社："+element.Item.publisherName+"</p>"+
                          "</a>"+
                        "</div>"+
                      "</li>"
          });
          $('.lists').append(result);
          console.log(data);
          $('.lists').after(pager);
          if(param.page === 1) {
            $('.prev').addClass('disabled'); //前へは無効化
          } else {
            $('.prev').removeClass('disabled');
          }
          console.log('------------------------')
          console.log(data.pageCount)
          console.log('------------------------')
          if(param.page === data.pageCount) {
            $('.next').addClass('disabled');
            param.isMax = true;
          } else {
            $('.next').removeClass('disabled');
            param.isMax = false;
          }
          if(data.count === 0) {  //返ってきたデータが0件だったら、
            $('.js-pager').remove(); //前へ、次へボタン消去
            errorText('検索結果が見つかりませんでした。<br>別のキーワードで検索して下さい。');
            // $('.lists').before('<div class="message">検索結果が見つかりませんでした。<br>別のキーワードで検索して下さい。</div>');
          }
        }

        // ajax失敗時の処理
        function miss(error) {
          console.log(error);
          $('.js-pager').remove(); //前へ、次へボタン消去
          //検索ワードの指定がない
          //検索ワードが半角英数字1文字
          console.log(error.status);

          if(error.status === 400) {  //リクエストエラー
            errorText('検索文字が空、もしくは半角英数1文字になっています');
          } else if(error.status === 429) {  //「検索する」を連打したとき
            errorText('ボタン連打しないでください。困ります。');
          } else if(error.status === 0) {  //ネットが切れている
            errorText('通信に失敗しました。インターネットの接続をご確認ください');
          } else { //その他（該当しないとき）のエラー
            errorText('原因不明のエラーです。');
          }
        }
      });
            //エラー時にも前へと次へボタンが出っぱなし 【解決！天才！】
            //ネットが切れているときのコードが501ではない【解決…？多分天才！】
            //jpXHRは定義していないと使えないようです【解決！天才！】
            //ここで表示された文言を消去しないといけない 【解決！天才！】
        // window.addEventListener("offline", function() {  //ネットが切れている
        //   $('.lists').before('<div class="message">通信に失敗しました。インターネットの接続をご確認ください</div>');
        // }, false);
        // window.addEventListener("online", function () {
        //   console.log('---------------------------')
        // }, false);
        // $('#js-search-button').on('click',function() {
        //   $('.lists__item').remove();
        //   var enteredWord = $('#js-search-word').val();
        //   }).done(function(data) {
        //     // この中にデータ取得後の動きを記述していきます。
        //     console.log(data);
        //     console.log($(this));

            // $('.lists').append(result);
        //     var pager = "<div class='js-pager'>"+
        //       "<ul class='btn-wrapper'>"+
        //         "<li class='prev btn-item'>"+
        //           "<a class='btn-anchor' href=''>前へ</a>"+
        //           "</li>"+
        //           "<li class='next btn-item'><a class='btn-anchor' href=''>次へ</a></li>"+
        //           // ".append('<li class='next btn-item'><a class='btn-anchor' href=''>次へ</a></li>)"+
        //           "</ul>"+
        //           "</div>"
        //     $('.lists').after(pager);
        //     console.log(pager);

        //     var page = function() {
        //       if(date.Items > 20) {
        //         page = 1
        //       } else {
        //         for (var i = 2; i < data.Items.length; i++) {
        //           page[i] =20*i+1
        //         }
        //       }
        //     }

        //     $('.prev').on('click',function() {
        //       test();
        //     });
        //     $('.next').on('click',function() {
        //       test();
        //     });
        //     function test() {
        //       if(page === 1) { //最初のページなら
        //         $('.prev').addClass('disabled'); //前へは無効化
        //         $('.next').on('click',function() {
        //           window.history.forward();  //次へは次へのページへ
        //         });
        //       } else if (page === last) { //最後のページなら
        //         $('.next').addClass('disabled'); //次へは無効化
        //         $('.prev').on('click',function() {
        //           window.history.back();//前へは前へのページへ
        //         });
        //       } else {  //最初でも最後のページでもなければ
        //         $('.prev').on('click',function() {
        //           window.history.back();//前へは前へのページへ
        //         });
        //         $('.next').on('click',function() {
        //           window.history.forward();//次へは次へのページへ
        //         });
        //       }
        //     }
        //   }).fail(function() {
        //     $('.message').remove();
        //     $('.lists').before('<div class="message">検索文字が空、もしくは半角英数1文字になっています</div>');
            // $('.lists').after('<p>検索文字が空、もしくは半角英数1文字になっています</p>');
            // $(this).css('textAlign', 'center');
        // });
    </script>
  </body>
</html>